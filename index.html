<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Future</title>
    <meta name="viewport" content="initial-scale=1,width=device-width"/> 
	<link rel="stylesheet" href="css/normalize.css">
	<link rel="stylesheet" href="css/header.css">
	<link rel=stylesheet href="css/container.css">
	<!--<link rel="stylesheet" href="css/icon.css">-->
	<link rel="stylesheet" href="css/btn.css">
</head>
<body>
    <header id="header">
        <img src="img/if_facebook__social__media_icon_2986194.svg" alt="Amazing line art of a scone" class="img-responsive"/>
        <a href="Login/login.html" class="ListItem" target="_blank" id="login">ç™»å½•/æ³¨å†Œ</a>
        <!--<a href="Edit/edit.html" class="ListItem" target="_blank">å‘å¸–</a>-->
    </header>


	<div class="container" id="blogsList">

		<!--<div class="mypanel" v-for="node in nodes">
			<header class="mypanel-title">
				<h3 >{{node.title}} </h3>
			</header>
			&lt;!&ndash;<div class="mypanel-author">
				<h3 class="mypanel-title">æŸ¥æ‹‰å›¾æ–¯</h3>
			</div>&ndash;&gt;
			<main class="mypanel-body" >
				{{{node.bodyHTML}}}
			</main>
			<footer>
				<button class="btn">ğŸ‘</button>
				<p>number {{node.number}}</p>
			</footer>
		</div>-->

	</div>
    <script>
        var conf = {
            repositoryOwner:"gitblog666",
            repositoryName:"program",
            client_id:"66212aa2c8c2293b9020",
            token:""
        }
        function initConf(conf){
            localStorage._repositoryOwner = conf.repositoryOwner
            localStorage._repositoryName  = conf.repositoryName
            localStorage._client_id       = conf.client_id
            localStorage._token           = conf.token
        }
        initConf()
    </script>
    <script src="/js/static/jquery.js"></script>
    <script>
        /*
        * https://www.jianshu.com/p/073f79c5e438
        * æ­£åˆ™è¡¨è¾¾å¼è·å¾—urlä¸­çš„token
        * */
        function getQueryString(name) {
            let reg = new RegExp('(^|&)' + name + '=([^&]*)(&|$)', 'i');
            let r = window.location.search.substr(1).match(reg);

            if (r != null) {
                return unescape(r[2]);
            }
            return null;
        }
        let token = getQueryString("token")
        if(token == undefined && localStorage._token == undefined){
            //è¯´æ˜ç”¨æˆ·æ˜¯ç›´æ¥è®¿é—®é¦–é¡µå¹¶ä¸”ä¹‹å‰æ²¡æœ‰ç™»é™†è¿‡
        }else if(token) {
            //å¦‚æœtokenæœ‰å€¼ï¼Œè¯´æ˜ç”¨æˆ·æ˜¯ç”¨GitHubç™»å½•åé‡å®šå‘åˆ°é¦–é¡µçš„
            //å°†tokenå­˜å‚¨åœ¨localStorageæ–¹ä¾¿å…¶ä»–é¡µé¢ä½¿ç”¨
            localStorage._token = token
        }

        // å­˜å‚¨ä¸€ä¸‹ headerä¸­çš„HTMLï¼Œç•™ä½œé€€å‡ºç™»å½•ä½¿ç”¨
        let headerHTML = document.getElementById("header").innerHTML

        //å¦‚æœç”¨æˆ·å¤„äºç™»å½•çŠ¶æ€ï¼Œåˆ™ä¿®æ”¹header
        if(localStorage._token){
            $.ajax({
                url: "https://api.github.com/user",
                type: 'get',
                data: {
                    access_token:localStorage._token,
                },
                success:  function (data) {

                    let header = document.getElementById("header")

                    header.innerHTML = `<img src="${data.avatar_url}" class="img-responsive"/>
                                        <a href="${data.html_url}" class="ListItem" target="_blank" >${data.login}</a>
                                        <a href="/Edit/edit.html" class="ListItem" target="_blank" >å†™åšå®¢</a>
                                        <button id="logOut">é€€å‡ºç™»å½•</button>`

                    document.getElementById("logOut").onclick = function () {
                        localStorage._token = ''
                        document.getElementById("header").innerHTML = headerHTML

                    }
                }
            });
        }

    </script>
    <script>
        // è·å¾—æœ€è¿‘çš„ 10 ä¸ªissue å¹¶å°†å®ƒä»¬æ¸²æŸ“åˆ°é¡µé¢
        let issuesCount = 10
        let query = `{
                  repository(owner: "${localStorage._repositoryOwner}", name: "${localStorage._repositoryName}") {
                    issues(last:${issuesCount}){
                      nodes{
                        title
                        bodyHTML
                        id
                        number
                      }
                    }
                  }
                }`

        $.ajax({
            url: "https://api.github.com/graphql",
            type: 'post',
            beforeSend: function(xhr) {
                if(localStorage._token) {
                    xhr.setRequestHeader("Authorization", "token " + localStorage._token);
                }
            },
            data: JSON.stringify({
                query: query
            }) ,
            success:  function (data) {

                //è¿˜è¦ä¿®æ”¹ï¼Œåˆ†ä¸ºæ¬¡æ•°é™åˆ¶ã€è®¿é—®æƒé™ç­‰
                if(!data.data.repository){
                    alert("å› ä¸ºgithubAPIé™åˆ¶ï¼Œä½ å¿…é¡»ç™»å½•åä½¿ç”¨")
                }

                let nodes = data.data.repository.issues.nodes

                var blogsListInnerHTML = ``
                for (let i = 0; i<nodes.length; i++ ){

                    titleLink = `https://saltfish666.github.io/article.html?repositoryOwner=${localStorage._repositoryOwner}
                                                                            &repositoryName=${localStorage._repositoryName}&issueNum=${nodes[i].number}`

                    blogsListInnerHTML = `<div class="mypanel" v-for="node in nodes">
                                             <header class="mypanel-title">
                                                <a href="${titleLink}" target="_blank"><h3 >${nodes[i].title} </h3></a>
                                             </header>

                                             <main class="mypanel-body" >
                                                ${nodes[i].bodyHTML}
                                             </main>

                                             <footer>
                                                 <button class="btn">ğŸ‘</button>
                                             </footer>
                                           </div>`      +    blogsListInnerHTML
                }
                document.getElementById("blogsList").innerHTML = blogsListInnerHTML
            }
        });
    </script>


</body>
</html>